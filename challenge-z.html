<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Challenge Z</title>
    <link rel="stylesheet" href="css/global.css">
    <style>
        .grid-5x5 { grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); width: 90vw; height: 90vw; max-width: 400px; max-height: 400px; }
        .difficulty-select { display: flex; justify-content: space-around; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button onclick="location.href='index.html'">Back</button>
            <h2>Challenge Z</h2>
        </div>

        <div id="setup-screen">
            <h3>Select Difficulty</h3>
            <div class="difficulty-select">
                <button class="btn-joseon" onclick="startGame('normal')">Normal (Top 10%)</button>
                <button class="btn-joseon" onclick="startGame('hard')">Hard (Top 5%)</button>
                <button class="btn-joseon" onclick="startGame('extreme')">Extreme (Top 1%)</button>
            </div>
        </div>

        <div id="game-screen" style="display:none;">
            <div class="score-board">Max Tile: <span id="max-tile">A</span></div>
            <div id="grid" class="grid-container grid-5x5">
                </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { saveRecord } from './js/challenge-logic.js';

        let grid = [];
        let difficulty = 'normal';
        let maxTileChar = 'A'; // ASCII 65

        window.startGame = (diff) => {
            difficulty = diff;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            initGrid();
        };

        function initGrid() {
            // Create 5x5 empty grid
            grid = Array(5).fill().map(() => Array(5).fill(null));
            spawnTile();
            spawnTile();
            drawGrid();
            setupTouchListeners();
        }

        function getSpawnConfig() {
            const maxCode = maxTileChar.charCodeAt(0);
            
            // Logic implementation based on your tables
            let allowed = ['A', 'B']; // Default start
            let weights = [0.9, 0.1]; // Mostly A
            
            if (difficulty === 'normal') {
                // Table 1 Logic
                if (maxCode >= 70) allowed = allowed.filter(t => t !== 'A'); // F removes A
                if (maxCode >= 73) allowed = allowed.filter(t => t !== 'B'); // I removes B
                if (maxCode >= 76) allowed = allowed.filter(t => t !== 'C'); // L removes C
                
                if (maxCode >= 71) { // G adds C/D/E
                    allowed = ['C', 'D', 'E']; 
                    weights = [0.6, 0.3, 0.1];
                }
                if (maxCode >= 74) { // J adds D/E/F
                    allowed = ['D', 'E', 'F'];
                    weights = [0.6, 0.3, 0.1];
                }
            } 
            // ... Add 'hard' and 'extreme' logic here following same pattern ...
            
            return { allowed, weights };
        }

        function spawnTile() {
            // Simplified weighted random
            const config = getSpawnConfig();
            const r = Math.random();
            // Select tile based on weights (logic omitted for brevity)
            // Place on random empty cell
        }

        // ... Standard 2048 Move/Merge Logic ...
        
        function drawGrid() {
            const container = document.getElementById('grid');
            container.innerHTML = '';
            grid.flat().forEach(val => {
                const div = document.createElement('div');
                div.className = 'tile';
                div.textContent = val || '';
                if(val) div.setAttribute('data-val', val);
                container.appendChild(div);
            });
            document.getElementById('max-tile').textContent = maxTileChar;
        }

        // Input handling (Touch/Swipe)
        function setupTouchListeners() {
            // Add touchstart/touchend logic here to trigger move()
        }
    </script>
</body>
</html>
